#!/usr/bin/env node

var Hapi = require('hapi')
var plugin = require('../index')
var good = require('good')
var loggerOptions = require('../lib/logger-options')

var server = new Hapi.Server({
  timeout: {
    server: 0, // бесконечно
    socket: 0  // бесконечно
  }
})
var port = parseInt(process.env.CORSPROXY_PORT || process.env.PORT || 1337, 10)
var host = (process.env.CORSPROXY_HOST || 'localhost');
var maxPayload = parseInt(process.env.CORSPROXY_MAX_PAYLOAD || 1048576, 10)
var proxy = server.connection({ port: port, labels: ['proxy'], host: host})

server.register(require('inert'), function () {})
server.register(require('h2o2'), function () {})

// cors plugin
server.register(plugin, {
  select: ['proxy']
}, function (error) {
  if (error) server.log('error', error)
})

// logger plugin
server.register({
  register: good,
  options: loggerOptions
}, function (error) {
  if (error) server.log('error', error)
})

// proxy route
proxy.route({
  method: '*',
  path: '/{host}/{path*}',
  handler: {
    proxy: {
      passThrough: true,
      xforward: true,
      mapUri: function (request, callback) {
        const host = request.params.host;
        const path = '/' + request.path.split('/').slice(2).join('/');
        const query = request.url.search || '';
        callback(null, `http://${host}${path}${query}`, request.headers);
      },
      onResponse: function (err, res, request, reply, settings, ttl) {
        reply(res)
          .header('Content-Type', 'text/event-stream')
          .header('Cache-Control', 'no-cache')
          .header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, DELETE')
          .header('Access-Control-Allow-Origin', '*')
          .header('Access-Control-Allow-Headers', 'Content-Type, Authorization')
          .header('Connection', 'keep-alive');
      }
    }
  },
  config: {
    payload: {
      maxBytes: maxPayload
    },
    timeout: {
      socket: false // disable timeout
    }
  }
});

// default route
proxy.route({
  method: 'GET',
  path: '/',
  handler: {
    file: 'public/index.html'
  }
})
proxy.route({
  method: 'GET',
  path: '/favicon.ico',
  handler: {
    file: 'public/favicon.ico'
  }
})

if (process.env.DEBUG) {
  var testport = port + 1
  var test = server.connection({ port: testport, labels: ['test'], host: host })

  server.register(require('vision'), function (error) {
    if (error) {
      throw error
    }

    server.views({
      engines: { ejs: require('ejs') },
      path: 'public/test'
    })
  })

  test.route({
    method: 'GET',
    path: '/favicon.ico',
    handler: {
      file: 'public/favicon.ico'
    }
  })
  test.route({
    method: 'GET',
    path: '/test.json',
    handler: {
      file: 'public/test/test.json'
    }
  })

  test.route({
    method: 'GET',
    path: '/',
    handler: function (request, reply) {
      reply.view('index', {
        proxyPort: proxy.info.port,
        testPort: test.info.port
      })
    }
  })

  server.log('info', 'Debug server starting at: ' + test.info.uri)
}

server.start(function (error) {
  if (error) server.log('error', error)

  server.log('info', 'CORS Proxy running at: ' + proxy.info.uri)
})
